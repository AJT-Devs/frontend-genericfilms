//Download ticket

async function downloadTicket(){
   let url = "";
    try {
        url = await getDownloadUrlOfTicket();
   }
   catch(error){
        return console.error("Erro ao acessar ingresso:", error);
   }
   
   try {
        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Authorization": `Bearer ${getToken()}`,
                'Content-Type': 'application/pdf'
        }});

        const blob = await response.blob();

        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const ticket = await getTicket();
        a.download = `ingresso-${ticket.movieTitle.replaceAll(" ", "-")}-${ticket.startDate.replaceAll("/", "-")}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(a.href);
    } catch (error) {
        return console.error("Erro ao baixar o ingresso:", error);
    }

}

//Acessar url de download de ingresso em servidor

async function getDownloadUrlOfTicket(){
    //logica para buscar url
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = +urlParams.get("ticket");

    return  `${urlServer}/ticket/pdf/${ticketId}`;
}

async function getTicket(){
    const urlParams = new URLSearchParams(window.location.search);
    const ticketId = +urlParams.get("ticket");

    const token = getToken();

    const response = await fetch(`${urlServer}/ticket/${ticketId}`,{
        method: "GET",
        headers: {
            "Authorization" : `Bearer ${token}`,
            'Content-Type': 'application/json'
        }   
    });

    const data = await response.json();
    return data;
}

async function previewTicket(){
    const data = await getTicket();
    data.startHour = data.startHour.slice(0, 5).replace(":", "h");
    data.endHour = data.endHour.slice(0, 5).replace(":", "h");

    data.isPCD? data.seat = `${data.seat} (PCD)` : data.seat = data.seat;

    const title = document.querySelector('#title-pagina-p');
    title.textContent = `Ingresso ${data.typeReserve}  - ${data.seat} - ID#${data.id}`;
    
    const ticket = document.querySelector('#ticket');

    data.price = Number(data.price).toFixed(2).replace(".", ",");

    ticket.innerHTML = `
        <span>
                    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
                    <svg
                        viewBox="0 0 151.28119 46.981619"
                        xmlns="http://www.w3.org/2000/svg"
                        xmlns:svg="http://www.w3.org/2000/svg">
                        <path
                            style="fill-opacity:1;stroke-width:0.300322"
                            d="m 144.90277,0.85415 c -4.2164,0.078 -7.43872,1.45728 -9.76633,3.85919 -2.28355,2.38305 -3.41959,5.42221 -3.41116,9.20668 0.008,3.76109 1.07339,6.75077 3.19412,9.02012 2.1637,2.28796 5.30818,3.61769 9.55084,3.77961 2.07593,0.0792 3.89855,-0.12177 5.48132,-0.59428 0,0 0.46326,-4.33715 0.66766,-6.25853 0,0 -0.41985,-0.26635 -0.62994,-0.39894 -0.68368,0.23633 -1.48532,0.41807 -2.40553,0.54467 -0.89386,0.10193 -1.70879,0.14158 -2.44482,0.11989 -1.7355,-0.0511 -3.00719,-0.64905 -3.82302,-1.75752 -0.81515,-1.13223 -1.22522,-2.8548 -1.23248,-5.19658 -0.006,-1.99866 0.34312,-3.45239 1.05006,-4.331 0.7071,-0.90391 1.86044,-1.37749 3.46336,-1.38906 0.76216,-0.006 1.58918,0.10442 2.48357,0.33176 0.8941,0.20159 1.6831,0.48213 2.36781,0.84026 0,0 0.3407,-0.20544 0.51108,-0.30851 0,0 0.87756,-4.16161 1.32188,-6.41046 -2.00003,-0.74265 -4.1169,-1.09912 -6.37842,-1.0573 z M 14.35882,1.04432 C 9.735575,0.92867 6.19015,2.08878 3.694873,4.39502 1.22991,6.69794 -0.003538,10.00736 8e-6,14.33653 c 0.0032,3.94718 1.059819,7.0385 3.169316,9.23096 2.11403,2.17037 5.227287,3.24884 9.361184,3.10575 3.043348,-0.10534 6.038979,-0.83973 9.098669,-2.15077 0,0 -0.0046,-1.20289 -0.0098,-2.62103 8.57e-4,0.26691 -0.01355,-3.868 -0.01447,-4.12119 9.28e-4,-0.0271 0.07237,-2.11463 0.10852,-3.14658 0,0 -4.800179,0.35809 -7.20266,0.54363 0,0 0.08516,2.64855 0.128674,4.02508 0,0 0.0025,0.80414 0.0036,1.21078 -0.577841,0.11829 -1.049921,0.18323 -1.418002,0.19379 -1.314503,0.0377 -2.325626,-0.12655 -3.037023,-0.49196 C 9.503574,19.72367 9.016307,19.04625 8.725056,18.0934 8.433849,17.11565 8.286497,15.71675 8.282706,13.90451 c -0.0037,-1.78742 0.13787,-3.15375 0.42478,-4.10155 0.286967,-0.948 0.744669,-1.61091 1.374076,-1.98076 0.656293,-0.36984 1.58691,-0.54482 2.795178,-0.52503 1.129228,0.0185 2.16547,0.17476 3.111438,0.46353 0.97387,0.2897 2.112563,0.7514 3.428214,1.37511 0,0 0.419966,0.005 0.629936,0.008 0,0 1.117829,-4.32152 1.6769,-6.68176 C 19.640696,1.59752 17.200672,1.11565 14.35882,1.04457 Z m 114.2111,0.44441 c -1.3e-4,0.003 -0.002,0.0793 -0.006,0.21808 h 5.2e-4 c 0.004,-0.15174 0.006,-0.22132 0.006,-0.21808 z m -0.006,0.21808 c -0.0437,0.001 -5.3644,0.14537 -8.03103,0.21756 0,0 0.0571,3.21216 0.13746,6.52415 0.13221,5.1647 0.12254,4.55873 0.25476,9.72343 0,0 -0.26029,4.52688 -0.39532,7.14892 0,0 5.27645,0.19868 7.91579,0.30282 0,0 -0.0463,-1.46698 -0.10852,-3.15071 -0.0673,-1.82044 -0.13585,-3.46267 -0.19482,-4.82451 -6e-5,-0.001 6e-5,-0.002 0,-0.004 0.0477,-1.7874 0.37375,-14.14021 0.42168,-15.93804 z M 25.146474,1.78541 c 0,0 0.07326,3.15021 0.161748,6.54275 0.276951,10.09384 0.420444,15.32744 0.475939,17.35398 2.439952,-0.0912 12.177603,-0.45311 17.375683,-0.61857 0,0 0.0701,-1.02484 0.1602,-2.2071 0.0982,-1.2892 0.19219,-2.41951 0.27491,-3.37292 0,0 -0.28971,-0.32007 -0.43459,-0.47904 -2.17717,0.12002 -4.34597,0.24397 -6.52364,0.37259 0,0 -2.51597,0.0673 -3.77444,0.1018 0,0 -0.0578,-1.32779 -0.0863,-1.97611 0,0 0.0234,-0.87682 0.0351,-1.30999 0,0 2.35869,-0.0373 3.53828,-0.0553 0,0 3.03969,0.0211 4.55993,0.032 0,0 0.30731,-3.17714 0.46302,-4.77128 0,0 -0.28868,-0.30725 -0.43305,-0.46199 0,0 -2.72607,0.0499 -4.08967,0.0755 0,0 -2.59559,-0.0154 -3.89382,-0.0233 0,0 0.0484,-2.05908 0.0734,-3.15123 0,0 2.70144,0.0463 4.05247,0.0687 0,0 4.17007,0.20685 6.25543,0.30541 0,0 0.33979,-3.42523 0.50901,-5.3697 0,0 -0.28851,-0.38198 -0.43305,-0.57567 0,0 -12.176533,-0.31161 -18.266581,-0.48059 z m 0.637687,23.89673 h -5.16e-4 c 0.03455,1.25498 0.04055,1.46192 5.16e-4,0 z m -5.16e-4,0 c -0.199092,-7.23221 -1.3534,-49.27024 -0.202055,-7.30808 0,0 -0.244194,4.68129 -0.362769,7.32926 0,0 0.201117,-0.008 0.564824,-0.0212 z M 107.77759,2.20967 c 0,0 -8.056616,0.2044 -12.086076,0.2837 0,0 0.0549,3.17328 0.12557,6.24355 0.0758,3.29122 0.16151,6.29042 0.23772,8.96896 0,0 -0.24898,4.28884 -0.36432,6.90966 0,0 5.271986,0.10496 7.909586,0.17156 0,0 -0.0515,-1.34677 -0.11369,-2.84995 -0.067,-1.61963 -0.13083,-3.06609 -0.18293,-4.22765 0,0 1.76032,0.0291 2.64066,0.0444 0.48532,1.02922 1.01719,2.10396 1.6614,3.41064 0.63324,1.26016 1.05556,2.1593 1.26659,2.59003 0,0 0.31662,0.67829 0.47491,1.02629 0,0 0.4995,0.45658 0.7493,0.68885 2.60308,-0.0897 5.22932,-0.52174 7.91373,-1.26039 0,0 0.0789,-0.58297 0.11834,-0.8692 -2.09516,-2.85237 -3.58421,-4.78299 -5.68285,-7.52615 1.33871,-0.76845 2.37821,-1.69539 3.11247,-2.78536 0.76153,-1.09135 1.14204,-2.27395 1.14256,-3.57446 9e-4,-2.21317 -0.77052,-4.03523 -2.31562,-5.32061 -1.55574,-1.32037 -3.7357,-1.99109 -6.60735,-1.92391 z M 46.443884,2.33421 c 0,0 0.0682,3.15397 0.14831,6.30711 0.0865,3.40705 0.17593,6.47133 0.25838,9.26093 0,0 -0.23991,4.41522 -0.34882,7.05848 0,0 4.76935,-0.13594 7.15461,-0.19378 0,0 -0.0679,-1.64198 -0.14522,-3.42615 0.15104,3.38391 -0.37117,-8.36242 -0.22014,-4.97851 0,0 0.0217,-2.3521 0.0346,-3.51503 0,0 0.31451,-3e-4 0.4718,-5.1e-4 0,0 1.20519,1.76986 2.68873,4.04729 1.68287,2.58345 3.11737,4.97348 4.52117,7.7184 0,0 5.71225,-0.0895 8.5695,-0.11576 0,0 -0.0674,-1.47811 -0.14418,-3.08457 -0.0814,-1.70468 -0.15956,-3.27527 -0.21859,-4.46019 0.13214,-4.6324 0.301,-8.45689 0.4563,-14.46268 0,0 -4.82895,0.26924 -7.244,0.39119 0,0 0.0367,2.30933 0.0801,4.6731 0.0478,2.60265 0.0929,4.7225 0.13746,6.65179 0,0 -0.3145,9.5e-4 -0.47181,0.002 0,0 -1.20652,-1.72931 -2.68045,-3.99459 -1.67034,-2.56712 -3.08881,-4.98352 -4.46588,-7.71477 0,0 -5.72072,-0.10133 -8.5819,-0.1633 z m 46.21629,0.20567 c 0,0 -12.17617,0.12985 -18.26606,0.12558 0,0 0.0588,3.15753 0.12919,6.16241 0.0769,3.28353 0.15766,6.079 0.23822,8.77104 0,0 -0.24281,4.23686 -0.34933,6.86573 0,0 11.9527,0.008 17.93379,0.0961 0,0 0.072,-1.01539 0.16381,-2.16989 0.10006,-1.25844 0.19617,-2.3506 0.28061,-3.2644 0,0 -0.28973,-0.31774 -0.4346,-0.47491 -2.17975,0.0426 -4.35574,0.0896 -6.53449,0.14263 0,0 -2.51815,-0.0139 -3.77754,-0.0181 0,0 -0.0568,-1.22177 -0.0842,-1.81023 0,0 0.0249,-0.79221 0.0377,-1.18132 0,0 2.3608,0.005 3.5419,0.009 0,0 3.04388,0.0735 4.56665,0.11317 0,0 0.31579,-2.95979 0.47697,-4.45812 0,0 -0.28802,-0.28691 -0.43202,-0.43098 0,0 -2.7294,0.0693 -4.09432,0.10283 0,0 -2.5974,0.005 -3.8964,0.007 0,0 0.0573,-1.85383 0.0879,-2.87579 0,0 2.70233,-0.0107 4.05401,-0.0181 0,0 4.17183,0.10613 6.25854,0.15555 0,0 0.35319,-3.33887 0.53071,-5.28908 0,0 -0.28727,-0.37132 -0.43098,-0.56018 z m 12.305186,4.96611 c 1.2087,0.0291 2.07242,0.27165 2.59778,0.72192 0.55045,0.4261 0.82489,1.09067 0.82372,1.96732 -0.001,0.78898 -0.17237,1.41188 -0.51418,1.88205 -0.34173,0.47007 -0.88085,0.84029 -1.61644,1.1126 0,0 -1.91744,-0.0903 -2.87631,-0.13436 0,0 0.10892,-3.46774 0.16795,-5.42603 0,0 0.94475,-0.0821 1.41748,-0.1235 z m -56.630446,26.37013 -0.0296,4.85171 2.54419,0.0296 2.60335,-0.0888 0.14792,0.20709 -0.14792,1.68626 -2.81044,-0.0296 -2.36669,0.0296 v 1.6271 l 0.0592,4.61504 h -2.18919 l 0.0592,-4.43754 -0.0592,-10.29509 h 8.57925 l 0.11833,0.1775 -0.1775,1.71585 -3.63878,-0.11833 z m 11.53758,8.31299 0.0592,4.61504 h -2.18919 l 0.0888,-4.43754 -0.0888,-10.29509 h 2.21877 z m 13.46056,2.95836 -0.14792,1.65668 h -7.83965 l 0.0888,-4.43754 -0.0888,-10.29509 h 2.21877 l -0.0888,10.11759 0.0592,2.75128 h 5.68006 z m 18.90394,1.65668 h -1.9821 l -0.32542,-4.4967 -0.79876,-6.80423 h -0.1775 l -4.23045,9.64425 h -1.74543 l -3.99379,-9.64425 h -0.1775 l -0.76918,6.62672 -0.41417,4.67421 h -1.89335 l 1.6271,-14.73263 h 2.57378 l 0.73959,2.21877 3.22461,7.9284 h 0.1775 l 3.37253,-8.04673 0.76917,-2.10044 h 2.51461 z M 101.11209,31.9236 q 1.8046,0 3.6092,0.71001 l -0.38459,2.18918 -0.355,0.0888 q -0.82834,-0.65084 -1.56793,-0.94668 -0.73959,-0.32542 -1.53835,-0.32542 -1.272086,0 -2.011676,0.68042 -0.73959,0.65084 -0.73959,1.50877 0,0.85792 0.71,1.39043 0.73959,0.5325 2.248356,1.18334 1.33126,0.59167 2.10043,1.06501 0.79876,0.47334 1.36085,1.27209 0.59167,0.76918 0.59167,1.89336 0,1.15376 -0.62126,2.1596 -0.62125,0.97626 -1.83418,1.59751 -1.18334,0.59167 -2.840016,0.59167 -1.03543,0 -2.18919,-0.23666 -1.12418,-0.26626 -2.10044,-0.76918 l 0.26626,-2.3371 0.29583,-0.11834 q 0.82834,0.82834 1.92294,1.30168 1.12417,0.44376 2.070846,0.44376 1.24251,0 2.04127,-0.65084 0.79875,-0.68043 0.79875,-1.6271 0,-0.88751 -0.73959,-1.42001 -0.71,-0.53251 -2.248346,-1.24252 -1.2721,-0.56208 -2.10044,-1.03542 -0.79875,-0.47334 -1.36084,-1.24251 -0.56209,-0.79876 -0.56209,-1.92294 0,-1.18334 0.62126,-2.13002 0.65083,-0.94667 1.8046,-1.50876 1.18334,-0.56209 2.751266,-0.56209 z" 
                        />
                    </svg>
                </span>

                <h1>Ingresso ${data.typeReserve}  - ${data.seat} - Sala ${data.roomName}</h1>

                <div class="information-session">
                    <div class="img-poster-div">
                        <img src="${data.moviePoster}" id="img-poster">
                    </div>
                    <div class="other-informations">
                        <h2>Informações da sessão</h2>
                        <ul>
                            <li>${data.movieTitle}</li>
                            <li style="text-transform: none">${data.startDate} - ${data.startHour} - ${data.endHour}</li>
                            <li>${data.cinemaName}</li>
                            <li>${data.cinemaAddress}, ${data.cinemaCity}, ${data.cinemaUF}</li>
                            <li>sala ${data.roomName}</li>
                            <li>${data.format} - ${data.language}</li>
                        </ul>
                    </div>
                </div>

                <div class="group-information">
                    <h2>Poltrona</h2>
                    <div class="poltrona-div">
                        <h3>${data.seat}</h3>
                    </div>
                </div>
                
                <div class="group-information">
                    <h2>Ingresso</h2>
                    <img src="${data.qrcode}" alt="QR-Code do ingresso" class="qrcode-ticket" >
                </div>

                <div class="group-information">
                    <h2>Valor pago</h2>
                    <p>R$ ${data.price}</p>
                    <p class="information-valor-pago">*Ingresso tipo ${data.typeReserve}, valor unitário de ${data.price}</p>
                </div>

                <p id="id-ingresso-p">Ingresso ID#${data.id}</p>
    `
}